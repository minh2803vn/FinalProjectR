---
title: "Finalproject"
author: "Thanh Minh"
date: "2023-04-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}
deck = rep(c(1:10, 10, 10, 10), 4)

shuffle_decks = function(n){ 
  sample(rep(deck, n))
}

```

```{r}
handValue = function(cards) {
  value = sum(cards)
  # Check for an Ace and change value if it doesn’t bust
  if (any(cards == 1) && value <= 11){
  value = value + 10
  }
  # Check bust (set to 0); check black jack (set to 21.5)
  if(value > 21){
  return(0)
  }
  else if (value == 21 && length(cards) == 2){
    return(21.5) # Blackjack
  }
  else{
  return(value)
  }
}
```

```{r}
winnings = function(dealer, players){
  (players > dealer & players > 21 ) * 1.5 + # blackjack
  (players > dealer & players <= 21) * 1 + # win
  (players < dealer | players == 0) * -1 # lose
}
```

```{r}
test_cards = list(c(10, 1), c(10, 5, 6), c(10, 1, 1),
    c(7, 6, 1, 5), c(3, 6, 1, 1),
    c(2, 3, 4, 10), c(5, 1, 9, 1, 1),
    c(5, 10, 7), c(10, 9, 1, 1, 1))

test_cards_val = c(21.5, 21, 12, 19, 21, 19, 17, 0, 0)

identical(test_cards_val, sapply(test_cards, handValue))

test_vals = c(0, 16, 19, 20, 21, 21.5)
testWinnings =
 matrix(c(-1, 1, 1, 1, 1, 1.5,
          -1, 0, 1, 1, 1, 1.5,
          -1, -1, 0, 1, 1, 1.5,
          -1, -1, -1, 0, 1, 1.5,
          -1, -1, -1, -1, 0, 1.5,
            -1, -1, -1, -1, -1, 0),
   nrow = length(test_vals), byrow = TRUE)
dimnames(testWinnings) = list(dealer = test_vals,
      player = test_vals)
testWinnings

check = testWinnings
check[] = NA
for(i in seq_along(test_vals)) {
  for(j in seq_along(test_vals)) {
 check[i, j] = winnings(test_vals[i], test_vals[j])
 }
}
identical(check, testWinnings)
```

```{r}
shoe = function(m = 1) sample(deck, m, replace = TRUE)
new_hand = function(shoe, cards = shoe(2), bet = 1, ...) {
  structure(list(bet = bet, shoe = shoe, cards = cards),
  class = "hand")
}
print.hand = function(x, ...) {
  cat("Blackjack hand: ", paste(x$cards, collapse = "-"),
  " (", handValue(x$cards), "). Bet: ", x$bet,
  "\n", sep = "")
}
myCards = new_hand(shoe, bet = 7)
myCards

hit = function(hand) {
  hand$cards = c(hand$cards, hand$shoe(1))
  hand
}
hit(myCards)

stand = function(hand) 
  hand

dd = function(hand) {
 hand$bet = hand$bet * 2
 hand = hit(hand)
 stand(hand)
}
dd(myCards)

splitPair = function(hand) {
 list(
 new_hand(hand$shoe,
    cards = c(hand$cards[1], hand$shoe(1)),
    bet = hand$bet),
 new_hand(hand$shoe,
   cards = c(hand$cards[2], hand$shoe(1)),
   bet = hand$bet)
)
}
splitHand = splitPair(myCards)
splitHand

set.seed(1014)
dealer = new_hand(shoe)
player = new_hand(shoe)
dealer$cards[1]
player
player = hit(player)
player
dealer
dealer = hit(dealer)
dealer
winnings(handValue(dealer$cards), handValue(player$cards))
```
```{r}
strategy_simple = function(mine, dealerFaceUp) {
  if (handValue(mine) == 0) return("S")
  if (handValue(dealerFaceUp) > 6 && handValue(mine) < 17) {
    return("H")
  } else {
    return("S")
  }
}

```

```{r}
dealer_cards = function(shoe) {
 cards = shoe(2)
 while(handValue(cards) < 17 && handValue(cards) > 0) {
 cards = c(cards, shoe(1))
}
 cards
}

play_hand = function(shoe, strategy,
     hand = new_hand(shoe),
     dealer = dealer_cards(shoe),
     verbose = FALSE,
     split = TRUE) {
 if (verbose) {
 cat("New hand \n")
 cat(" Dealer: ", paste(dealer, collapse = "-"),
   " (", handValue(dealer), ")\n", sep = "")
 cat(" Player: ", paste(hand$cards, collapse = "-"),
   ": ", sep = "")
}
 if (hand$cards[1] == hand$cards[2] && split) {
   hands = splitPair(hand)
   one = play_hand(shoe, strategy, hands[[1]], dealer,
     verbose = verbose, split = FALSE)
   two = play_hand(shoe, strategy, hands[[2]], dealer,
     verbose = verbose, split = FALSE)
   return(one + two)
 }
 face_card = dealer[1]
 action = strategy(hand$cards, face_card)
 while(action != "S" && handValue(hand$cards) != 0) {
 if (verbose) cat(action)
 if (action == "H") {
  hand = hit(hand)
  action = strategy(hand$cards, face_card)
} else if (action == "D") {
  hand = dd(hand)
  action = "S"
} else {
  stop("Unknown action: should be one of S, H, D, SP")
}
}
 if (verbose) {
 cat(action, " -> ", paste(hand$cards, collapse = "-"),
   " (", handValue(hand$cards), ")", sep = "", "\n")
}
 winnings(handValue(dealer), handValue(hand$cards)) * hand$bet
}
  


play_hand(shoe, strategy_simple, verbose = TRUE)

```

```{r}
lookuptable = read.csv("blackjack.csv", header = TRUE,
    stringsAsFactors = FALSE, check.names = FALSE)
lookuptable

# Load the function
strategy_optimal = function(player_hand, dealerFaceUp,
                             optimal = lookuptable) {
  # Stand if 21 or already busted
  player_value = handValue(player_hand)
  if (player_value == 0) return("S")
  if (player_value >= 21) return("S")
  dealer_value = handValue(dealerFaceUp)
  loc_ace = player_hand == 1
  if (length(player_hand) == 2 && player_hand[1] == player_hand[2]) {
    type = "pair"
    if (player_hand[1] == 1) player_value = 2
  } else if (sum(loc_ace) > 0 && (player_value - sum(loc_ace)) > handValue(player_hand[!loc_ace])) {
    type = "soft"
  } else {
    type = "hard"
  }
  out = optimal[optimal$type == type & optimal$value == player_value, as.character(dealer_value)]
  if (length(out) == 0) {
    out = "S" # set default action to "S" if lookup table is missing the entry
  }
  if (out == "Dh") {
    if (length(player_hand) > 2) {
      out = "H"
    } else {
      out = "D"
    }
  }
  if (out == "Ds") {
    if (length(player_hand) > 2) {
      out = "S"
    } else {
      out = "D"
    }
  }
  out
}

```

```{r}
set.seed(10)
win_optimal = replicate(500, play_hand(shoe = shoe,
       strategy = strategy_optimal))
win_simple = replicate(500, play_hand(shoe = shoe,
       strategy = strategy_simple))
plot(density(win_optimal, bw = 0.25), col = "green", lwd = 2,
 xlab = "Winnings", xlim = c(-3, 3),
 ylim = c(0, 0.9), main = "")
lines(density(win_simple, bw = 0.25), col = "purple", lwd = 2)
legend("topright", col = c("green", "purple"),
  legend = c("Optimal", "Simple"), bty = "n", lty = 1)

mean(win_optimal)
mean(win_simple)

```


```{r}
payoff <- function(n, strategy, shoe) {
  results <- replicate(n, play_hand(shoe = shoe, strategy = strategy))
  c(avgGain = mean(results), sdGain = sd(results), medGain = median(results))
}

win_simple50 = replicate(100,
     payoff(50, strategy_simple, shoe))
win_optimal50 = replicate(100,
     payoff(50, strategy_optimal, shoe))

library(ggplot2)

df = data.frame (
 value = c(win_simple50["avgGain",],
   win_optimal50["avgGain",]),
 strategy = rep(c("simple", "optimal"), each = 1000))
library(ggplot2)
qplot(value, data = df, geom = "freqpoly", colour = strategy,
  binwidth = 0.05)

```


```{r}
Counter = setRefClass("Counter",
 fields = list("count" = "numeric"),
 methods = list(
 initialize = function() {
   count <<- 1
},
 increment = function() {
  count <<- count + 1
}
))
ctr1 = Counter$new()
ctr1$count

ctr2 = Counter$new()
ctr2$count
ctr1$increment()
ctr1$count
ctr2$count
ctr2$increment()
ctr2$increment()
ctr2$increment()
ctr2$count
```



```{r}
Shoe <- setRefClass("Shoe",
  fields = list(
    decks = "numeric", # number of decks
    cards = "numeric", # vector of cards
    pos = "numeric", # current position in shoe
    debug = "logical" # display informative messages?
  ),
  methods = list(
    shuffle = function() {
      if (debug) message("Shuffling the shoe")
      cards <<- shuffle_decks(decks)
      pos <<- 0
    },
    draw_n = function(n) {
      if (decks_left() < 1) {
        shuffle()
      }
      
      cards_drawn <- cards[(pos + 1):(pos + n)]
      pos <<- pos + n
      
      return(cards_drawn)
    },
    decks_left = function() {
      return(floor((decks * 52 - pos) / 52))
    },
    played = function() {
      return(cards[seq_len(pos)])
    }
  )
)

new_shoe = function(decks = 6, debug = FALSE) {
 shoe = Shoe$new(decks = decks, debug = debug)
 shoe$shuffle()
 shoe
}
my_shoe = new_shoe(decks = 3, debug = TRUE)
my_shoe$draw_n(12)
my_shoe$pos
my_shoe$decks_left()
my_shoe = new_shoe(decks = 6, debug = TRUE)
replicate(3, play_hand(shoe = my_shoe$draw_n,
      strategy = strategy_optimal,
      verbose = TRUE))
my_shoe$pos = 0
payoff(50, strategy_simple, my_shoe$draw_n)
my_shoe$pos


```
```{r}
hi_low <- function(cards) {
  # Initialize the Hi-Lo count to 0
  count <- 0
  
  for (card in cards) {
    # Convert the card value to a numeric value
    if (is.numeric(card)) {
      value <- card
    } else if (card %in% c("J", "Q", "K")) {
      value <- 10
    } else if (card == "A") {
      value <- 1
    }
    
    # Update the Hi-Lo count based on the card value
    if (value %in% c(2:6)) {
      count <- count + 1
    } else if (value %in% c(10, "J", "Q", "K", "A")) {
      count <- count - 1
    }
  }
  
  return(count)
}
bet = function(count) pmax(floor(count), 1)
plot(bet, from = -5, to = 10)


```

```{r}
count_payoff = function(shoe, n = 100) {
  gain = numeric(n)
  count = numeric(n)
  gain[1] = play_hand(shoe$draw_n, strategy_simple)
  count[1] = 0
  for (i in 2:n) {
  count[i] = hi_low(shoe$played())
  gain[i] = play_hand(shoe$draw_n, strategy_simple)
 }
  c(sum(gain), sum(gain * bet(count)))
}
set.seed(155100)
my_shoe = new_shoe()
payoffs = replicate(1000, count_payoff(my_shoe, 50))
apply(payoffs, 1, mean)
apply(payoffs, 1, sd)
diffs = payoffs[2,] - payoffs[1,]
mean(diffs)
sd(diffs)

```

#### Background: Blackjack
We start our computer model of blackjack with a model for a deck of cards that is relevant to blackjack.Each suit has a card labeled 2, 3, ..., 10 and a Jack, Queen, King, and Ace. The Jack, Queen, and King all have the same value (10). In the beginning of the game:

```{r}
deck <- rep(c(1:10, 10, 10, 10), 4)
deck

# Shuffle the deck
deck <- sample(deck)
  
# Deal two cards to the player and the dealer
player_hand <- deck[1:2]
player_hand
dealer_hand <- deck[3:4]
dealer_hand
```

#### Count Hand Value
In blackjack, the player’s hand has 2 or more cards, and if the total value of the cards in the hand exceeds that of the dealer’s hand, but does not exceed 21, then the player wins. First, we have to compute the value of a hand of cards. This function should allow us to compare 2 hands of cards to see which is the winner.

```{r}
#'card' is a vector
handValue <- function(cards) {
  value = sum(cards)
  # Check for an Ace and change value if it doesn’t bust
  if ((any(cards == 1) && value <= 11)) {
    value = value + 10
  }
  # Check bust (set to 0); 
  if(value > 21) {
    return(0)
  }
  # check black jack (set to 21.5)
  else if (value == 21 && length(cards) == 2) {
    return(22.5) # Natural Blackjack 
  }
  else if (value == 21 && length(cards) > 2) {
    return(21.5) # 21 with three or more cards
  }
  else {
    return(value)
  }
}

bust <- c(10,10,2)
nothinglow <- c(10,2)
nothinghigh <- c(10,10)
normalblackjack <- c(10,5,6)
natural <- c(10,1)
```
#### Who wins?
To compute the winnings, we need to know the value of the player’s hand and the dealer’s hand. In blackjack, there are several scenario:
1/ If the player goes bust then the player loses, even if the dealer also goes bust.
2/ If the player gets blackjack and the dealer does not have blackjack, the player win
3/ If both the dealer and the player have blackjack, then who ever have more cards win. If both have the same number of cards, they are tie
4/ If both the player and the dealer don;t have blackjack, then whoever has the the higher, unbusted hand win
```{r}
# There is only one player, but there are many players
winnings <- function(dealer, players) {
playerwin = T
    if ((players == 0) &&  (players != 21.5) &&  (players != 22.5)) {
      # If player busted => automatic lost
      playerwin = F
    } 
    else if ((dealer == players) || ((dealer == 21.5) && (players == 21.5)) || (players == 0) && (dealer == 0)) {
    playerwin = NA
    # Tie conditions
    }
    # Dealer busted, player stand or 21
    else if ((dealer == 0) && ((players < 21) || (players == 21.5) || (players == 22.5))) {
      playerwin = T
    }
  #both player and dealer stand, no one has 21
  else if ((players < 21) && (dealer < 21)) {
    if (dealer > players) {
        playerwin = F
    }
  }
#both player and dealer stand, player has 21, dealder can stand or have a natural or blackjack
  else if (((players == 21.5) || (players == 22.5)) && (dealer > 21) || (dealer < 21)) {
    if (((dealer == 22.5) && (players == 21.5))) {
      playerwin = F
  }
    else {
      playerwin = T
    }
  }
else {
   playerwin = F
 }

if (is.na(playerwin)) {
  return("TIE")
}
else if (playerwin == T) {
  return("PLAYER WIN")
}

else  {
  return("PLAYER LOST")
}
}
```

#### Strageties for the player
If the player initial two cards are less than 21, the player has three SIMPLE strategies:
1/ Aggressive Gambler: Take cards until busted or reach 21
2/ Balanced Player: Take one more card then stand
3/ Cautious Player: Stand no matter how
#### Aggressive Gambler Function
```{r}
aggressive <- function (){
  # Create a deck of cards
deck <- rep(c(1:10, 10, 10, 10), 4)
#Shuffle the deck  
deck <- sample(deck)
# Deal two cards to the player and the dealer
player_hand <- deck[1:2]
dealer_hand <- deck[3:4]
# cat("Player hand:", paste(player_hand, collapse = ", "), "\n")
# cat("Player score:", paste(handValue(player_hand), collapse = ", "), "\n")
# cat("Dealer hand:", paste(dealer_hand[1], dealer_hand[2], sep = ", "), "\n\n")
#Player turn: Take cards until busted or reach 21
while ((handValue(player_hand) < 21) && (handValue(player_hand)) != 0)  {
# Deal another card to the player
player_hand <- c(player_hand, deck[length(player_hand) + 3])
}
# cat("Player hand:", paste(player_hand, collapse = ", "), "\n")
# cat("Player score:", paste(handValue(player_hand), collapse = ", "), "\n")
#Dealer turn: Must hit if under 16 and stay from 17 through 21
while ((handValue(dealer_hand) <= 16) && (handValue(dealer_hand)) != 0)  {
      # Deal another card to the dealer
      dealer_hand <- c(dealer_hand, deck[length(dealer_hand) + 3])
      #Calculate dealer_hand again
#      cat("Dealer hand:", paste(dealer_hand), "\n\n")
#      cat("Dealer score:", paste(handValue(dealer_hand), collapse = ", "), "\n")
      if ((handValue(dealer_hand) >= 17) && (handValue(dealer_hand) <= 21))
      {
        break
      }
}
#Decide who wins 
winnings(handValue(dealer_hand),handValue(player_hand))
}
aggressive <- replicate(1000, aggressive())
table(aggressive)
```
#### Balanced Player Function
```{r}
balanced <- function (){
# Create a deck of cards
deck <- rep(c(1:10, 10, 10, 10), 4)
#Shuffle the deck  
deck <- sample(deck)
# Deal two cards to the player and the dealer
player_hand <- deck[1:2]
dealer_hand <- deck[3:4]
# cat("Player hand:", paste(player_hand, collapse = ", "), "\n")
# cat("Player score:", paste(handValue(player_hand), collapse = ", "), "\n")
# cat("Dealer hand:", paste(dealer_hand[1], dealer_hand[2], sep = ", "), "\n\n")

#Player turn: Take ONLY ONE MORE card if under 21

if (handValue(player_hand) < 21)  {
# Deal another card to the player
player_hand <- c(player_hand, deck[length(player_hand) + 3])
}

# cat("Player hand:", paste(player_hand, collapse = ", "), "\n")
# cat("Player score:", paste(handValue(player_hand), collapse = ", "), "\n")
#Dealer turn: Must hit if under 16 and stay from 17 through 21
while ((handValue(dealer_hand) <= 16) && (handValue(dealer_hand)) != 0)  {
      # Deal another card to the dealer
      dealer_hand <- c(dealer_hand, deck[length(dealer_hand) + 3])
      #Calculate dealer_hand again
#      cat("Dealer hand:", paste(dealer_hand), "\n\n")
#      cat("Dealer score:", paste(handValue(dealer_hand), collapse = ", "), "\n")
      if ((handValue(dealer_hand) >= 17) && (handValue(dealer_hand) <= 21))
      {
        break
      }
}
#Decide who wins 
winnings(handValue(dealer_hand),handValue(player_hand))
}
balanced <- replicate(1000, balanced())
table(balanced)
```
#### Cautious Player Function
```{r}
cautious <- function (){
# Create a deck of cards
deck <- rep(c(1:10, 10, 10, 10), 4)
#Shuffle the deck  
deck <- sample(deck)
# Deal two cards to the player and the dealer
player_hand <- deck[1:2]
dealer_hand <- deck[3:4]
# cat("Player hand:", paste(player_hand, collapse = ", "), "\n")
# cat("Player score:", paste(handValue(player_hand), collapse = ", "), "\n")
# cat("Dealer hand:", paste(dealer_hand[1], dealer_hand[2], sep = ", "), "\n\n")

#Player does not do anything
# cat("Player hand:", paste(player_hand, collapse = ", "), "\n")
# cat("Player score:", paste(handValue(player_hand), collapse = ", "), "\n")
#Dealer turn: Must hit if under 16 and stay from 17 through 21
while ((handValue(dealer_hand) <= 16) && (handValue(dealer_hand)) != 0)  {
      # Deal another card to the dealer
      dealer_hand <- c(dealer_hand, deck[length(dealer_hand) + 3])
      #Calculate dealer_hand again
#      cat("Dealer hand:", paste(dealer_hand), "\n\n")
#      cat("Dealer score:", paste(handValue(dealer_hand), collapse = ", "), "\n")
      if ((handValue(dealer_hand) >= 17) && (handValue(dealer_hand) <= 21))
      {
        break
      }
}
#Decide who wins 
winnings(handValue(dealer_hand),handValue(player_hand))
}
cautious <- replicate(1000, cautious())
table(cautious)
```

#### Finding of three strageties
**From what we found, when everything is automatic, the cautious player would have the best win rate compared to the other strategies**
```{r}
table(aggressive)
table(balanced)
table(cautious)
```
#### Card Counting Stragety
```{r}
# Set up the count
count <- 0

# Define the card counting function
card_count <- function(card) {
  count <<- count + sum(card %in% 2:6) - sum(card %in% c(10, "J", "Q", "K", "A"))
  return(count)
}  

# Define the player's strategy
# Hit if the running count is 0 or higher, otherwise stand
  player_action <- function(count) {
    if (count < 0) {
     return("stand") 
    }
    return("hit")
  }
```
#### Card Counting Advanced Stragety applied in a game
```{r}
# Play a single hand of Blackjack
count = 0
card_count_stragety <- function(count) {
  # Shuffle the deck
deck <- sample(deck)
# Deal the player's hand
player_hand <- sample(deck, 2)
# print(paste("Player Cards", player_hand))
# print(paste("Count", card_count(player_hand)))
# Deal the dealer's hand
dealer_hand <- sample(deck, 2)
dealer_card <- dealer_hand[1]
# print(paste("Dealer Cards", dealer_card, " X"))
# print(paste("Count", card_count(dealer_card)))
player_action(count)


# Player's turn
while (player_action(count) == "hit") {
player_hand <- c(player_hand, sample(deck, 1))
card_count(player_hand[length(player_hand)])
    if (handValue(player_hand) > 21) {
      break
    }
}

  # Dealer's turn
while ((handValue(dealer_hand) <= 16) && (handValue(dealer_hand)) != 0)  {
      # Deal another card to the dealer
      dealer_hand <- c(dealer_hand, sample(deck, 1))
      if ((handValue(dealer_hand) >= 17) && (handValue(dealer_hand) <= 21))
      {
        break
      }
}
# Determine the winner
winnings(handValue(dealer_hand),handValue(player_hand))
}
card_count_stragety(count)
```
#### TESTING
```{r}
# Play a single hand of Blackjack
count = 0
  # Shuffle the deck
deck <- sample(deck)
# Deal the player's hand
player_hand <- sample(deck, 2)
player_hand
print(paste("Count", card_count(player_hand)))
# Deal the dealer's hand
dealer_hand <- sample(deck, 2)
dealer_card <- dealer_hand[1]
print(paste("Dealer Cards", dealer_card, " X"))
print(paste("Count", card_count(dealer_card)))

stragety <- player_action(count)
stragety

# Player's turn: #ERROR is here
while (stragety == "hit") {
player_hand <- c(player_hand, sample(deck, 1)) #pick one card
stragety <- player_action(card_count(player_hand))  #count the card
    if (handValue(player_hand) > 21) {
      break
    }
}
player_hand
stragety




  # Dealer's turn
while ((handValue(dealer_hand) <= 16) && (handValue(dealer_hand)) != 0)  {
      # Deal another card to the dealer
      dealer_hand <- c(dealer_hand, sample(deck, 1))
      if ((handValue(dealer_hand) >= 17) && (handValue(dealer_hand) <= 21))
      {
        break
      }
}
# Determine the winner
winnings(handValue(dealer_hand),handValue(player_hand))
```
